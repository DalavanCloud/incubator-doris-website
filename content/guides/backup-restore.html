<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>备份与恢复</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/incubator.css" rel="stylesheet">
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="https://www.apache.org/favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
   

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://doris.apache.org"><i class="icon-home"></i>Apache Doris</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documents <b class="caret"></b></a>
              <ul class="dropdown-menu">
                
                  <li><a href="http://doris.apache.org/guides/backup-restore.html">备份与恢复</a></li>
                
                  <li><a href="http://doris.apache.org/guides/deploy-upgrade.html">部署和升级</a></li>
                
                  <li><a href="http://doris.apache.org/guides/metadata-design.html">元数据设计文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/best-practices.html">最佳实践</a></li>
                
                  <li><a href="http://doris.apache.org/guides/documents.html">Doris 文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/monitor-alert.html">监控和报警</a></li>
                
                  <li><a href="http://doris.apache.org/guides/create-load-and-delete.html">Doris 文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/multi-tenant.html">多租户设计</a></li>
                
                  <li><a href="http://doris.apache.org/guides/data-model-rollup-prefix-index.html">数据模型和索引</a></li>
                
                  <li><a href="http://doris.apache.org/guides/install.html">安装文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/privilege.html">权限管理</a></li>
                
                  <li><a href="http://doris.apache.org/guides/sql_reference.html">SQL reference</a></li>
                
                  <li><a href="http://doris.apache.org/guides/getting-start.html">Tutorial</a></li>
                
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Community <b class="caret"></b></a>
              <ul class="dropdown-menu">
                
                  <li><a href="http://doris.apache.org/policy/contributing.html">如何做贡献</a></li>
                
                  <li><a href="http://doris.apache.org/policy/pull-request.html">代码提交指南</a></li>
                
                  <li><a href="http://doris.apache.org/policy/subscribe-mail-list.html">订阅邮件列表</a></li>
                
                  <li><a href="http://doris.apache.org/policy/use-gitter.html">Gitter 使用指南</a></li>
                
              </ul>
             </li> 

	    <li><a href="http://doris.apache.org/downloads.html">Downloads </a></li>
	    <li><a href="http://doris.apache.org/faq.html">FAQs </a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-4 vcenter"><a href="https://www.apache.org/"><img src="http://www.apache.org/img/asf_logo.png" alt="The Apache Software Foundation" border="0" style="margin-top: 2px" width="250"></a></div>
          <div class="col-md-4 vcenter"><a href="/"><img src="https://incubator.apache.org/images/incubator_feather_egg_logo_sm.png" alt="The Apache Software Foundation Incubator" border="0" style="margin-top: 2px" height="100"></a></div>
          <div class="col-md-4 vcenter"><a href="https://www.apache.org/foundation/contributing.html"><img src="https://www.apache.org/images/SupportApache-small.png" height="75" width="75"></a></div>
      </div>
    </div>
    <div class="top-container container">


<div class="page-header">
    <h1>Guide :: 备份与恢复</h1>
</div>

<div class="article-body">

Estimated Reading Time: <span class="eta"></span>

<p><h1><a href="#backup-restore-备份与恢复" id="backup-restore-备份与恢复">Backup &amp; Restore 备份与恢复</a></h1> 
<p>Doris 支持将当前数据以文件的形式，通过 broker 备份到远端存储系统中。之后可以通过 恢复 命令，从远端存储系统中将数据恢复到任意 Doris 集群。通过这个功能，Doris 可以支持将数据定期的进行快照备份。也可以通过这个功能，在不同集群间进行数据迁移。</p> 
<p>该功能需要 Doris 版本 0.8.2+</p> 
<p>使用该功能，需要部署对应远端存储的 broker。如 BOS、HDFS 等。可以通过 <code>SHOW BROKER;</code> 查看当前部署的 broker。</p> 
<h2><a href="#简要原理说明" id="简要原理说明">简要原理说明</a></h2> 
<h3><a href="#备份" id="备份">备份</a></h3> 
<p>备份操作是将指定表或分区的数据，直接以 Doris 存储的文件的形式，上传到远端仓库中进行存储。主要有如下步骤：</p> 
<ol> 
 <li> <p>快照及快照上传</p> <p>快照阶段会对指定的表或分区数据文件进行快照。之后，备份都是对快照进行操作。在快照之后，对表进行的更改、导入等操作都不再影响备份的结果。快照只是对当前数据文件产生一个硬链，耗时很少。快照完成后，会开始对这些快照文件进行逐一上传。快照上传由各个 Backend 并发完成。</p> </li> 
 <li> <p>元数据准备及上传</p> <p>数据文件快照上传完成后，Frontend 会首先将对应元数据写成本地文件，然后通过 broker 将本地元数据文件上传到远端仓库。完成最终备份作业。</p> </li> 
</ol> 
<h3><a href="#恢复" id="恢复">恢复</a></h3> 
<p>恢复操作需要指定一个远端仓库中已存在的备份，然后将这个备份的内容恢复到本地集群中。主要有如下步骤：</p> 
<ol> 
 <li> <p>在本地创建对应的元数据</p> <p>这一步首先会在本地集群中，创建恢复对应的表分区等结构。创建完成后，该表可见，但是不可访问。</p> </li> 
 <li> <p>本地snapshot</p> <p>这一步是将上一步创建的表做一个快照。这其实是一个空快照（因为刚创建的表是没有数据的），其目的主要是在 Backend 上产生对应的快照目录，用于之后接收从远端仓库下载的快照文件。</p> </li> 
 <li> <p>下载快照</p> <p>远端仓库中的快照文件，会被下载到对应的上一步生成的快照目录中。这一步由各个 Backend 并发完成。</p> </li> 
 <li> <p>生效快照</p> <p>快照下载完成后，我们要将各个快照映射为当前本地表的元数据。然后重新加载这些快照，使之生效，完成最终的恢复作业。</p> </li> 
</ol> 
<h2><a href="#最佳实践" id="最佳实践">最佳实践</a></h2> 
<h3><a href="#备份" id="备份">备份</a></h3> 
<p>当前我们支持最小分区（Partition）粒度的全量备份（增量备份有可能在未来版本支持）。如果需要对数据进行定期备份，首先需要在建表时，合理的规划表的分区及分桶，比如按时间进行分区。然后在之后的运行过程中，按照分区粒度进行定期的数据备份。</p> 
<h3><a href="#数据迁移" id="数据迁移">数据迁移</a></h3> 
<p>用户可以先将数据备份到远端仓库，再通过远端仓库将数据恢复到另一个集群，完成数据迁移。因为数据备份是通过快照的形式完成的，所以，在备份作业的快照阶段之后的新的导入数据，是不会备份的。因此，在快照完成后，到恢复作业完成这期间，在原集群上导入的数据，都需要在新集群上同样导入一遍。</p> 
<p>建议在迁移完成后，对新旧两个集群并行导入一段时间。完成数据和业务正确性校验后，再将业务迁移到新的集群。</p> 
<h2><a href="#重点说明" id="重点说明">重点说明</a></h2> 
<ol> 
 <li>备份恢复相关的操作目前只允许拥有 ADMIN 权限的用户执行。</li> 
 <li>一个 Database 内，只允许有一个正在执行的备份或恢复作业。</li> 
 <li>备份和恢复都支持最小分区（Partition）级别的操作，当表的数据量很大时，建议按分区分别执行，以降低失败重试的代价。</li> 
 <li>因为备份恢复操作，操作的都是实际的数据文件。所以当一个表的分片过多，或者一个分片有过多的小版本时，可能即使总数据量很小，依然需要备份或恢复很长时间。用户可以通过 <code>SHOW PARTITIONS FROM table_name;</code> 和 <code>SHOW TABLET FROM table_name;</code> 来查看各个分区的分片数量，以及各个分片的文件版本数量，来预估作业执行时间。文件数量对作业执行的时间影响非常大，所以建议在建表时，合理规划分区分桶，以避免过多的分片。</li> 
 <li>当通过 <code>SHOW BACKUP</code> 或者 <code>SHOW RESTORE</code> 命令查看作业状态时。有可能会在 <code>TaskErrMsg</code> 一列中看到错误信息。但只要 <code>State</code> 列不为 <code>CANCELLED</code>，则说明作业依然在继续。这些 Task 有可能会重试成功。当然，有些 Task 错误，也会直接导致作业失败。</li> 
 <li>如果恢复作业是一次覆盖操作（指定恢复数据到已经存在的表或分区中），那么从恢复作业的 <code>COMMIT</code> 阶段开始，当前集群上被覆盖的数据有可能不能再被还原。此时如果恢复作业失败或被取消，有可能造成之前的数据已损坏且无法访问。这种情况下，只能通过再次执行恢复操作，并等待作业完成。因此，我们建议，如无必要，尽量不要使用覆盖的方式恢复数据，除非确认当前数据已不再使用。</li> 
</ol> 
<h2><a href="#相关命令" id="相关命令">相关命令</a></h2> 
<p>和备份恢复功能相关的命令如下。以下命令，都可以通过 mysql-client 连接 Doris 后，使用 <code>help cmd;</code> 的方式查看详细帮助。</p> 
<ol> 
 <li> <p>CREATE REPOSITORY</p> <p>创建一个远端仓库路径，用于备份或恢复。</p> </li> 
 <li> <p>BACKUP</p> <p>执行一次备份操作。</p> </li> 
 <li> <p>SHOW BACKUP</p> <p>查看最近一次 backup 作业的执行情况，包括：</p> 
  <ul> 
   <li>JobId：本次备份作业的 id。</li> 
   <li>SnapshotName：用户指定的本次备份作业的名称（Label）。</li> 
   <li>DbName：备份作业对应的 Database。</li> 
   <li>State：备份作业当前所在阶段： 
    <ul> 
     <li>PENDING：作业初始状态。</li> 
     <li>SNAPSHOTING：正在进行快照操作。</li> 
     <li>UPLOAD_SNAPSHOT：快照结束，准备上传。</li> 
     <li>UPLOADING：正在上传快照。</li> 
     <li>SAVE_META：正在本地生成元数据文件。</li> 
     <li>UPLOAD_INFO：上传元数据文件和本次备份作业的信息。</li> 
     <li>FINISHED：备份完成。</li> 
     <li>CANCELLED：备份失败或被取消。</li> 
    </ul> </li> 
   <li>BackupObjs：本次备份涉及的表和分区的清单。</li> 
   <li>CreateTime：作业创建时间。</li> 
   <li>SnapshotFinishedTime：快照完成时间。</li> 
   <li>UploadFinishedTime：快照上传完成时间。</li> 
   <li>FinishedTime：本次作业完成时间。</li> 
   <li>UnfinishedTasks：在 <code>SNAPSHOTTING</code>，<code>UPLOADING</code> 等阶段，会有多个子任务在同时进行，这里展示的当前阶段，未完成的子任务的 task id。</li> 
   <li>TaskErrMsg：如果有子任务执行出错，这里会显示对应子任务的错误信息。</li> 
   <li>Status：用于记录在整个作业过程中，可能出现的一些状态信息。</li> 
   <li>Timeout：作业的超时时间，单位是秒。</li> 
  </ul> </li> 
 <li> <p>SHOW SNAPSHOT</p> <p>查看远端仓库中已存在的备份。</p> 
  <ul> 
   <li>Snapshot：备份时指定的该备份的名称（Label）。</li> 
   <li>Timestamp：备份的时间戳。</li> 
   <li>Status：该备份是否正常。</li> 
  </ul> <p>如果在 <code>SHOW SNAPSHOT</code> 后指定了 where 子句，则可以显示更详细的备份信息。</p> 
  <ul> 
   <li>Database：备份时对应的 Database。</li> 
   <li>Details：展示了该备份完整的数据目录结构。</li> 
  </ul> </li> 
 <li> <p>RESTORE</p> <p>执行一次恢复操作。</p> </li> 
 <li> <p>SHOW RESTORE</p> <p>查看最近一次 restore 作业的执行情况，包括：</p> 
  <ul> 
   <li>JobId：本次恢复作业的 id。</li> 
   <li>Label：用户指定的仓库中备份的名称（Label）。</li> 
   <li>Timestamp：用户指定的仓库中备份的时间戳。</li> 
   <li>DbName：恢复作业对应的 Database。</li> 
   <li>State：恢复作业当前所在阶段： 
    <ul> 
     <li>PENDING：作业初始状态。</li> 
     <li>SNAPSHOTING：正在进行本地新建表的快照操作。</li> 
     <li>DOWNLOAD：正在发送下载快照任务。</li> 
     <li>DOWNLOADING：快照正在下载。</li> 
     <li>COMMIT：准备生效已下载的快照。</li> 
     <li>COMMITTING：正在生效已下载的快照。</li> 
     <li>FINISHED：恢复完成。</li> 
     <li>CANCELLED：恢复失败或被取消。</li> 
    </ul> </li> 
   <li>AllowLoad：恢复期间是否允许导入。</li> 
   <li>ReplicationNum：恢复指定的副本数。</li> 
   <li>RestoreObjs：本次恢复涉及的表和分区的清单。</li> 
   <li>CreateTime：作业创建时间。</li> 
   <li>MetaPreparedTime：本地元数据生成完成时间。</li> 
   <li>SnapshotFinishedTime：本地快照完成时间。</li> 
   <li>DownloadFinishedTime：远端快照下载完成时间。</li> 
   <li>FinishedTime：本次作业完成时间。</li> 
   <li>UnfinishedTasks：在 <code>SNAPSHOTTING</code>，<code>DOWNLOADING</code>, <code>COMMITTING</code> 等阶段，会有多个子任务在同时进行，这里展示的当前阶段，未完成的子任务的 task id。</li> 
   <li>TaskErrMsg：如果有子任务执行出错，这里会显示对应子任务的错误信息。</li> 
   <li>Status：用于记录在整个作业过程中，可能出现的一些状态信息。</li> 
   <li>Timeout：作业的超时时间，单位是秒。</li> 
  </ul> </li> 
 <li> <p>CANCEL BACKUP</p> <p>取消当前正在执行的备份作业。</p> </li> 
 <li> <p>CANCEL RESTORE</p> <p>取消当前正在执行的恢复作业。</p> </li> 
 <li> <p>DROP REPOSITORY</p> <p>删除已创建的远端仓库。删除仓库，仅仅是删除该仓库在 Doris 中的映射，不会删除实际的仓库数据。</p> </li> 
</ol></p>

</div>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
          <p class="muted credit">&copy; 2017 The Apache Software Foundation | Licensed under the Apache License, Version 2.0.<br/>
          Apache Incubator, Apache, the Apache feather logo, and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      </div>
    </div>

    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>
    <script src="../js/readingTime.js"></script>
    <script src="../js/incubator.js"></script>

  </body>
</html>
