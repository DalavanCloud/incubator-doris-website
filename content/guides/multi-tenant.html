<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>多租户设计</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/incubator.css" rel="stylesheet">
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="https://www.apache.org/favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
   

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://doris.apache.org"><i class="icon-home"></i>Apache Doris</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documents <b class="caret"></b></a>
              <ul class="dropdown-menu">
                
                  <li><a href="http://doris.apache.org/guides/backup-restore.html">备份与恢复</a></li>
                
                  <li><a href="http://doris.apache.org/guides/deploy-upgrade.html">部署和升级</a></li>
                
                  <li><a href="http://doris.apache.org/guides/metadata-design.html">元数据设计文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/best-practices.html">最佳实践</a></li>
                
                  <li><a href="http://doris.apache.org/guides/documents.html">Doris 文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/monitor-alert.html">监控和报警</a></li>
                
                  <li><a href="http://doris.apache.org/guides/create-load-and-delete.html">建表、数据导入与删除</a></li>
                
                  <li><a href="http://doris.apache.org/guides/multi-tenant.html">多租户设计</a></li>
                
                  <li><a href="http://doris.apache.org/guides/data-model-rollup-prefix-index.html">数据模型和索引</a></li>
                
                  <li><a href="http://doris.apache.org/guides/install.html">安装文档</a></li>
                
                  <li><a href="http://doris.apache.org/guides/privilege.html">权限管理</a></li>
                
                  <li><a href="http://doris.apache.org/guides/sql_reference.html">SQL reference</a></li>
                
                  <li><a href="http://doris.apache.org/guides/getting-start.html">Tutorial</a></li>
                
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Community <b class="caret"></b></a>
              <ul class="dropdown-menu">
                
                  <li><a href="http://doris.apache.org/policy/contributing.html">如何做贡献</a></li>
                
                  <li><a href="http://doris.apache.org/policy/pull-request.html">代码提交指南</a></li>
                
                  <li><a href="http://doris.apache.org/policy/subscribe-mail-list.html">订阅邮件列表</a></li>
                
                  <li><a href="http://doris.apache.org/policy/use-gitter.html">Gitter 使用指南</a></li>
                
              </ul>
             </li> 

	    <li><a href="http://doris.apache.org/downloads.html">Downloads </a></li>
	    <li><a href="http://doris.apache.org/faq.html">FAQs </a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-4 vcenter"><a href="https://www.apache.org/"><img src="http://www.apache.org/img/asf_logo.png" alt="The Apache Software Foundation" border="0" style="margin-top: 2px" width="250"></a></div>
          <div class="col-md-4 vcenter"><a href="/"><img src="https://incubator.apache.org/images/incubator_feather_egg_logo_sm.png" alt="The Apache Software Foundation Incubator" border="0" style="margin-top: 2px" height="100"></a></div>
          <div class="col-md-4 vcenter"><a href="https://www.apache.org/foundation/contributing.html"><img src="https://www.apache.org/images/SupportApache-small.png" height="75" width="75"></a></div>
      </div>
    </div>
    <div class="top-container container">


<div class="page-header">
    <h1>Guide :: 多租户设计</h1>
</div>

<div class="article-body">

Estimated Reading Time: <span class="eta"></span>

<p><h1><a href="#多租户设计" id="多租户设计">多租户设计</a></h1> 
<p>该功能为实验性质，暂不建议在生产环境使用。</p> 
<h2><a href="#背景" id="背景">背景</a></h2> 
<p>Doris作为一款PB级别的在线报表与多维分析数据库，对外通过开放云提供云端的数据库服务，并且对于每个云上的客户都单独部署了一套物理集群。对内，一套物理集群部署了多个业务，对于隔离性要求比较高的业务单独搭建了集群。针对以上存在几点问题：</p> 
<ul> 
 <li>部署多套物理集群维护代价大（升级、功能上线、bug修复）。</li> 
 <li>一个用户的查询或者查询引起的bug经常会影响其他用户。</li> 
 <li>实际生产环境单机只能部署一个BE进程。而多个BE可以更好的解决胖节点问题。并且对于join、聚合操作可以提供更高的并发度。</li> 
</ul> 
<p>综合以上三点，Doris需要新的多租户方案，既能做到较好的资源隔离和故障隔离，同时也能减少维护的代价，满足共有云和私有云的需求。</p> 
<h2><a href="#设计原则" id="设计原则">设计原则</a></h2> 
<ul> 
 <li>使用简单</li> 
 <li>开发代价小</li> 
 <li>方便现有集群的迁移</li> 
</ul> 
<h2><a href="#名词解释" id="名词解释">名词解释</a></h2> 
<ul> 
 <li>FE: Frontend，即 Doris 中用于元数据管理即查询规划的模块。</li> 
 <li>BE: Backend，即 Doris 中用于存储和查询数据的模块。</li> 
 <li>Master: FE 的一种角色。一个Doris集群只有一个Master，其他的FE为Observer或者Follower。</li> 
 <li>instance：一个 BE 进程及时一个 instance。</li> 
 <li>host：单个物理机</li> 
 <li>cluster：即一个集群，由多个instance组成。</li> 
 <li>租户：一个cluster属于一个租户。cluster和租户之间是一对一关系。</li> 
 <li>database：一个用户创建的数据库</li> 
</ul> 
<h2><a href="#主要思路" id="主要思路">主要思路</a></h2> 
<ul> 
 <li>一个host上部署多个BE的instance，在进程级别做资源隔离。</li> 
 <li>多个instance形成一个cluster，一个cluster分配给一个业务独立的的租户。</li> 
 <li>FE增加cluster这一级并负责cluster的管理。</li> 
 <li>CPU,IO,内存等资源隔离采用cgroup。</li> 
</ul> 
<h2><a href="#设计方案" id="设计方案">设计方案</a></h2> 
<p>为了能够达到隔离的目的，引入了<strong>虚拟cluster</strong>的概念。</p> 
<ol> 
 <li>cluster表示一个虚拟的集群，由多个BE的instance组成。多个cluster共享FE。</li> 
 <li>一个host上可以启动多个instance。cluster创建时，选取任意指定数量的instance，组成一个cluster。</li> 
 <li>创建cluster的同时，会创建一个名为superuser的账户，隶属于该cluster。superuser可以对cluster进行管理、创建数据库、分配权限等。</li> 
 <li>Doris启动后，汇创建一个默认的cluster：default_cluster。如果用户不希望使用多cluster的功能，则会提供这个默认的cluster，并隐藏多cluster的其他操作细节。</li> 
</ol> 
<p>具体架构如下图： <img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/multi_tenant_arch.png" alt=""></p> 
<h2><a href="#sql-接口" id="sql-接口">SQL 接口</a></h2> 
<ul> 
 <li> <p>登录</p> <p>默认集群登录名： user_name@default_cluster 或者 user_name</p> <p>自定义集群登录名：user_name@cluster_name</p> <p><code>mysqlclient -h host -P port -u user_name@cluster_name -p password</code></p> </li> 
 <li> <p>添加、删除、下线（decommission）以及取消下线BE</p> <p><code>ALTER SYSTEM ADD BACKEND "host:port"</code> <code>ALTER SYSTEM DROP BACKEND "host:port"</code> <code>ALTER SYSTEM DECOMMISSION BACKEND "host:port"</code> <code>CANCEL DECOMMISSION BACKEND "host:port"</code></p> <p>强烈建议使用 DECOMMISSION 而不是 DROP 来删除 BACKEND。DECOMMISSION 操作会首先将需要下线节点上的数据拷贝到集群内其他instance上。之后，才会真正下线。</p> </li> 
 <li> <p>创建集群，并指定superuser账户的密码</p> <p><code>CREATE CLUSTER cluster_name PROPERTIES ("instance_num" = "10") identified by "password"</code></p> </li> 
 <li> <p>进入一个集群</p> <p><code>ENTER cluster_name</code></p> </li> 
 <li> <p>集群扩容、缩容</p> <p><code>ALTER CLUSTER cluster_name PROPERTIES ("instance_num" = "10")</code></p> <p>当指定的实例个数多于cluster现有be的个数，则为扩容，如果少于则为缩容。</p> </li> 
 <li> <p>链接、迁移db</p> <p><code>LINK DATABASE src_cluster_name.db_name dest_cluster_name.db_name</code></p> <p>软链一个cluster的db到另外一个cluster的db ，对于需要临时访问其他cluster的db却不需要进行实际数据迁移的用户可以采用这种方式。</p> <p><code>MIGRATE DATABASE src_cluster_name.db_name dest_cluster_name.db_name</code></p> <p>如果需要对db进行跨cluster的迁移，在链接之后，执行migrate对数据进行实际的迁移。</p> </li> 
</ul> 
<p>迁移不影响当前两个db的查询、导入等操作，这是一个异步的操作，可以通过<code>SHOW MIGRATIONS</code>查看迁移的进度。</p> 
<ul> 
 <li> <p>删除集群</p> <p><code>DROP CLUSTER cluster_name</code></p> <p>删除集群，要求先手动删除的集群内所有database。</p> </li> 
 <li> <p>其他</p> <p><code>SHOW CLUSTERS</code></p> <p>展示系统内已经创建的集群。只有root用户有该权限。</p> <p><code>SHOW BACKENDS</code></p> <p>查看集群内的BE instance。</p> <p><code>SHOW MIGRATIONS</code></p> <p>展示当前正在进行的db迁移任务。执行完db的迁移后可以通过此命令查看迁移的进度。</p> </li> 
</ul> 
<h2><a href="#详细设计" id="详细设计">详细设计</a></h2> 
<ol> 
 <li>命名空间隔离 <p>为了引入多租户，需要对系统内的cluster之间的命名空间进行隔离。</p> </li> 
</ol> 
<p>Doris现有的元数据采用的是image + journal 的方式(元数据的设计见相关文档)。Doris会把涉及元数据的操作的记录为一个 journal （操作日志），然后定时的按照<strong>图1</strong>的方式写成image，加载的时候按照写入的顺序读即可。但是这样就带来一个问题已经写入的格式不容易修改，比如记录数据分布的元数据格式为：database+table+tablet+replica 嵌套，如果按照以往的方式要做cluster之间的命名空间隔离，则需要在database上增加一层cluster，内部元数据的层级变为:cluster+database+table+tablet+replica，如<strong>图2</strong>所示。但加一层带来的问题有：</p> 
<ul> 
 <li>增加一层带来的元数据改动，不兼容，需要按照图2的方式cluster＋db＋table＋tablet＋replica层级写,这样就改变了以往的元数据组织方式，老版本的升级会比较麻烦，比较理想的方式是按照图3在现有元数据的格式下顺序写入cluster的元数据。 
  <ul> 
   <li>代码里所有用到db、user等，都需要加一层cluster，一工作量大改动的地方多，层级深，多数代码都获取db，现有功能几乎都要改一遍，并且需要在db的锁的基础上嵌套一层cluster的锁。</li> 
  </ul> <p><img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/palo_meta.png" alt=""></p> <p>综上这里采用了一种通过给db、user名加前缀的方式去隔离内部因为cluster之间db、user名字冲突的问题。</p> <p>如下，所有的sql输入涉及db名、user名的，都需要根据自己所在的cluster来拼写db、user的全名。</p> </li> 
</ul> 
<p><img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/cluster_namaspace.png" alt=""></p> 
<pre><code>采用这种方式以上两个问题不再有。元数据的组织方式也比较简单。即采用**图3**每个cluster记录下属于自己cluster的db、user，以及节点即可。
</code></pre> 
<ol> 
 <li>BE 节点管理 <p>每个cluster都有属于自己的一组instance，可以通过<code>SHOW BACKENDS</code>查看，为了区分出instance属于哪个cluster以及使用情况，BE引入了多个状态：</p> 
  <ul> 
   <li>free：当一个BE节点被加入系统内，此时be不属于任何cluster的时候处于空闲状态</li> 
   <li>using：当创建集群、或者扩容被选取到一个cluster内则处于使用中。</li> 
  </ul> </li> 
</ol> 
<ul> 
 <li>cluster decommission：如果执行缩容量，则正在执行缩容的be处于此状态。结束后，be状态变为free。</li> 
 <li>system decommission：be正在下线中。下线完成后，该be将会被永久删除。 <p>只有root用户可以通过<code>SHOW PROC "/backends"</code>中cluster这一项查看集群内所有be的是否被使用。为空则为空闲，否则为使用中。<code>SHOW BACKENDS</code>只能看到所在cluster的节点。以下是be节点状态变化的示意图。</p> <p><img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/backend_state.png" alt=""></p> </li> 
</ul> 
<ol> 
 <li> <p>创建集群</p> <p>只有root用户可以创建一个cluster，并指定任意数量的BE instance。</p> <p>支持在相同机器上选取多个instance。选择instance的大致原则是：尽可能选取不同机器上的be并且使所有机器上使用的be数尽可能均匀。</p> <p>对于使用来讲，每一个user、db都属于一个cluster（root除外）。为了创建user、db，首先需要进入一个cluster。在创建cluster的时候系统会默认生成这个cluster的管理员，即superuser账户。superuser具有在所属cluster内创建db、user，以及查看be节点数的权限。所有的非root用户登录必须指定一个cluster，即<code>user_name@cluster_name</code>。</p> <p>只有root用户可以通过<code>SHOW CLUSTER</code>查看系统内所有的cluster，并且可以通过@不同的集群名来进入不同的cluster。对于除了root之外的用户cluster都是不可见的。</p> <p>为了兼容老版本Doris内置了一个名字叫做default_cluster的集群，这个名字在创建集群的时候不能使用。</p> <p><img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/user_authority.png" alt=""></p> </li> 
 <li> <p>集群扩容</p> <p>集群扩容的流程同创建集群。会优先选取不在集群之外的host上的BE instance。选取的原则同创建集群。</p> </li> 
 <li> <p>集群缩容、CLUSTER DECOMMISSION</p> <p>用户可以通过设置 cluster 的 instance num 来进行集群缩容。</p> </li> 
</ol> 
<p>集群的缩容会优先在BE instance 数量最多的 host 上选取 instance 进行下线。</p> 
<pre><code>用户也可以直接使用 `ALTER CLUSTER DECOMMISSION BACKEND` 来指定BE，进行集群缩容。
</code></pre> 
<p><img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/replica_recover.png" alt=""></p> 
<ol> 
 <li> <p>建表</p> <p>为了保证高可用，每个分片的副本必需在不同的机器上。所以建表时，选择副本所在be的策略为在每个host上随机选取一个be。然后从这些be中随机选取所需副本数量的be。总体上做到每个机器上分片分布均匀。</p> <p>因此，加入需要创建一个3副本的分片，即使cluster包含3个或以上的instance，但是只有2个或以下的host，依然不能创建该分片。</p> </li> 
 <li> <p>负载均衡</p> <p>负载均衡的粒度为cluster级别，cluster之间不做负载均衡。但是在计算负载是在host一级进行的，而一个host上可能存在多个不同cluster的BE instance。 cluster内，会通过每个host上所有分片数目、存储使用率计算负载，然后把负载高的机器上的分片往负载低的机器上拷贝（详见负载均衡相关文档）。</p> </li> 
 <li> <p>LINK DATABASE（软链）</p> <p>多个集群之间可以通过软链的方式访问彼此的数据。链接的级别为不同cluster的db。</p> </li> 
</ol> 
<p>通过在一个cluster内，添加需要访问的其他cluster的db的信息，来访问其他cluster中的db。</p> 
<p>当查询链接的db时，所使用的计算以及存储资源为源db所在cluster的资源。</p> 
<p>被软链的db不能在源cluster中删除。只有链接的db被删除后，才可以删除源db。而删除链接db，不会删除源db。</p> 
<ol> 
 <li>MIGRATE DATABASE <p>db可以在cluster之间进行物理迁移。</p> </li> 
</ol> 
<p>要迁移db，必须先链接db。执行迁移后数据会迁移到链接的db所在的cluster，并且执行迁移后源db被删除，链接断开。</p> 
<p>数据的迁移，复用了负载均衡以及副本恢复中，复制数据的流程（详见负载均衡相关文档）。具体实现上，在执行<code>MIRAGTE</code>命令后，Doris会在元数据中，将源db的所有副本所属的cluster，修改为目的cluster。</p> 
<p>Doris会定期检查集群内机器之间是否均衡、副本是否齐全、是否有多余的副本。db的迁移即借用了这个流程，在检查副本齐全的时候同时检查副本所在的be是否属于该cluster，如果不属于，则记入要恢复的副本。并且副本多余要删除的时候会优先删除cluster外的副本，然后再按照现有的策略选择：宕机的be的副本-&gt;clone的副本-&gt;版本落后的副本-&gt;负载高的host上的副本，直到副本没有多余。</p> 
<p><img src="https://github.com/apache/incubator-doris/blob/master/docs/resources/cluster_link_and_migrate_db.png" alt=""></p> 
<ol> 
 <li>BE的进程隔离</li> 
</ol> 
<p>  为了实现be进程之间实际cpu、io以及内存的隔离，需要依赖于be的部署。部署的时候需要在外围配置cgroup，把要部署的be的进程都写入cgroup。如果要实现io的物理隔离各be配置的数据存放路径需要在不同磁盘上，这里不做过多的介绍。</p></p>

</div>

		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
          <p class="muted credit">&copy; 2017 The Apache Software Foundation | Licensed under the Apache License, Version 2.0.<br/>
          Apache Incubator, Apache, the Apache feather logo, and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      </div>
    </div>

    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>
    <script src="../js/readingTime.js"></script>
    <script src="../js/incubator.js"></script>

  </body>
</html>
